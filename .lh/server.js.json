{
    "sourceFile": "server.js",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763966047750,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763966047750,
            "name": "Commit-0",
            "content": "const express = require('express');\r\nconst mongoose = require('mongoose');\r\nconst bodyParser = require('body-parser');\r\nconst path = require('path');\r\nconst cassandra = require('cassandra-driver');\r\nconst waitPort = require('wait-port');\r\n// const redis = require('redis'); \r\nconst AWS = require('aws-sdk');\r\nconst app = express();\r\nconst PORT = 3000;\r\n\r\napp.use(bodyParser.json());\r\napp.use(bodyParser.urlencoded({ extended: true }));\r\napp.use(express.static('public'));\r\n\r\nconst MONGO_URI = process.env.MONGO_URI || 'mongodb://mongo:27017/testdb';\r\nconst CASSANDRA_CONTACT_POINTS = process.env.CASSANDRA_CONTACT_POINTS || 'cassandra:9042';\r\n\r\nconst cassandraClient = new cassandra.Client({\r\n    contactPoints: [CASSANDRA_CONTACT_POINTS],\r\n    localDataCenter: 'datacenter1'\r\n});\r\n\r\nAWS.config.update({\r\n  region: 'ap-southeast-1',\r\n  accessKeyId: 'nil',\r\n  secretAccessKey: 'nil'\r\n});\r\n\r\napp.use(express.json());\r\n\r\n// Configure DynamoDB\r\nAWS.config.update({\r\n  region: process.env.AWS_REGION || 'localhost',\r\n  endpoint: process.env.DYNAMODB_ENDPOINT || 'http://localhost:8000',\r\n  accessKeyId: process.env.AWS_ACCESS_KEY_ID || 'fake',\r\n  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY || 'fake'\r\n});\r\n\r\nconst dynamodb = new AWS.DynamoDB();\r\nconst documentClient = new AWS.DynamoDB.DocumentClient();\r\nconst TABLE_NAME = 'users';\r\n\r\n// const REDIS_URL = process.env.REDIS_URL || 'redis://redis:6379';\r\n// const redisClient = redis.createClient({\r\n//   url: REDIS_URL,\r\n//   legacyMode: true\r\n// });\r\n\r\n// redisClient.on('error', (err) => console.log('Redis Client Error', err));\r\n// redisClient.on('connect', () => console.log('Connected to Redis'));\r\n\r\nasync function initializeDynamoDB() {\r\n  try {\r\n    const tables = await dynamodb.listTables().promise();\r\n    \r\n    if (!tables.TableNames.includes(TABLE_NAME)) {\r\n      console.log('Creating users table...');\r\n      \r\n      const params = {\r\n        TableName: TABLE_NAME,\r\n        KeySchema: [\r\n          { AttributeName: 'username', KeyType: 'HASH' }\r\n        ],\r\n        AttributeDefinitions: [\r\n          { AttributeName: 'username', AttributeType: 'S' }\r\n        ],\r\n        ProvisionedThroughput: {\r\n          ReadCapacityUnits: 5,\r\n          WriteCapacityUnits: 5\r\n        }\r\n      };\r\n      \r\n      await dynamodb.createTable(params).promise();\r\n      console.log('Users table created successfully');\r\n      \r\n      await dynamodb.waitFor('tableExists', { TableName: TABLE_NAME }).promise();\r\n    } else {\r\n      console.log('Users table already exists');\r\n    }\r\n\r\n    const users = [\r\n      { username: 'admin', password: 'admin_testing', role: 'admin', secret: 'FLAG{n0sql_byp455}' },\r\n      { username: 'user1', password: 'password1', role: 'user', secret: 'nop' },\r\n      { username: 'test', password: 'test', role: 'user', secret: 'nop' }\r\n    ];\r\n\r\n    console.log('Inserting/updating users...');\r\n    \r\n    for (const user of users) {\r\n      try {\r\n        await documentClient.put({\r\n          TableName: TABLE_NAME,\r\n          Item: user,\r\n          ConditionExpression: 'attribute_not_exists(username)'\r\n        }).promise();\r\n      } catch (error) {\r\n        if (error.code === 'ConditionalCheckFailedException') {\r\n            await documentClient.put({\r\n            TableName: TABLE_NAME,\r\n            Item: user\r\n          }).promise();\r\n        } \r\n      }\r\n    }\r\n    \r\n    console.log('All users inserted/updated successfully');\r\n\r\n  } catch (error) {\r\n    console.error('Error initializing DynamoDB:', error.message);\r\n  }\r\n}\r\n\r\nconst userSchema = new mongoose.Schema({\r\n    username: String,\r\n    password: String,\r\n    role: String,\r\n    secret: String\r\n});\r\n\r\nconst UserModel = mongoose.model('User', userSchema);\r\n\r\n\r\nasync function initializeMongoData() {\r\n    await UserModel.deleteMany({});\r\n    await UserModel.create([\r\n        { username: 'admin', password: 'admin_testing', role: 'admin', secret: 'FLAG{n0sql_byp455}' },\r\n        { username: 'user1', password: 'password1', role: 'user', secret: 'nop' },\r\n        { username: 'test', password: 'test', role: 'user', secret: 'nop' }\r\n    ]);\r\n}\r\n\r\nasync function initializeRedisData() {\r\n    await redisClient.flushAll();\r\n    \r\n    const users = [\r\n        { username: 'admin', password: 'admin_testing', role: 'admin', secret: 'FLAG{n0sql_byp455}' },\r\n        { username: 'user1', password: 'password1', role: 'user', secret: 'nop' },\r\n        { username: 'test', password: 'test', role: 'user', secret: 'nop' }\r\n    ];\r\n    \r\n    for (const user of users) {\r\n        await redisClient.set(`user:${user.username}:password`, user.password);\r\n        await redisClient.set(`user:${user.username}:role`, user.role);\r\n        await redisClient.set(`user:${user.username}:secret`, user.secret);\r\n    }\r\n    \r\n    console.log('Redis data initialized');\r\n}\r\n\r\nasync function initializeCassandraData() {\r\n    await cassandraClient.execute(`\r\n        CREATE KEYSPACE IF NOT EXISTS auth_system\r\n        WITH replication = { 'class': 'SimpleStrategy', 'replication_factor': 1 }\r\n    `);\r\n    await cassandraClient.execute('USE auth_system');\r\n    await cassandraClient.execute(`\r\n        CREATE TABLE IF NOT EXISTS users (\r\n            username text PRIMARY KEY,\r\n            password text,\r\n            role text,\r\n            secret text\r\n        )\r\n    `);\r\n    await cassandraClient.execute('TRUNCATE users');\r\n    const queries = [\r\n        { query: 'INSERT INTO users (username, password, role, secret) VALUES (?, ?, ?, ?)', params: ['admin', 'admin_testing', 'admin', 'FLAG{n0sql_byp455}'] },\r\n        { query: 'INSERT INTO users (username, password, role, secret) VALUES (?, ?, ?, ?)', params: ['user1', 'password1', 'user', 'nop'] },\r\n        { query: 'INSERT INTO users (username, password, role, secret) VALUES (?, ?, ?, ?)', params: ['test', 'test', 'user', 'nop'] }\r\n    ];\r\n    for (const { query, params } of queries) {\r\n        await cassandraClient.execute(query, params, { prepare: true });\r\n    }\r\n}\r\n\r\n\r\nasync function startServer() {\r\n    await waitPort({ host: 'mongo', port: 27017 });\r\n    await waitPort({ host: 'cassandra', port: 9042 });\r\n    // await waitPort({ host: 'redis', port: 6379 });\r\n\r\n    await mongoose.connect(MONGO_URI, { useNewUrlParser: true, useUnifiedTopology: true });\r\n    await initializeMongoData();\r\n\r\n    await cassandraClient.connect();\r\n    await initializeCassandraData();\r\n\r\n    // await redisClient.connect();\r\n    // await initializeRedisData();\r\n\r\n    // await initializeDynamoDB()\r\n\r\n    app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));\r\n}\r\n\r\nstartServer().catch(err => console.error(err));\r\n\r\napp.get('/', (req, res) => res.sendFile(path.join(__dirname, 'public', 'index.html')));\r\napp.get('/level1', (req, res) => res.sendFile(path.join(__dirname, 'public', 'level1.html')));\r\napp.get('/level2', (req, res) => res.sendFile(path.join(__dirname, 'public', 'level2.html')));\r\napp.get('/level3', (req, res) => res.sendFile(path.join(__dirname, 'public', 'level3.html')));\r\napp.get('/level4', (req, res) => res.sendFile(path.join(__dirname, 'public', 'level4.html')));\r\napp.get('/level5', (req, res) => res.sendFile(path.join(__dirname, 'public', 'level5.html')));\r\n\r\n\r\napp.post('/level1/login', async (req, res) => {\r\n    const { username, password } = req.body;\r\n    const query = { $where: `this.username == '${username}' && this.password == '${password}'` };\r\n    const users = await UserModel.find(query);\r\n    if (users.length > 0) {\r\n        res.json({ success: true, message: 'Login successful', secret: users[0].secret });\r\n    } else {\r\n        res.status(401).json({ success: false, message: 'Invalid credentials' });\r\n    }\r\n});\r\n\r\napp.post('/level2/login', async (req, res) => {\r\n    const { username, password } = req.body;\r\n    const query = { $where: `(this.username == '${username}') && (this.password == '${password}')`};\r\n    const users = await UserModel.find(query);\r\n    if (users.length > 0) {\r\n        res.json({ success: true, message: 'Login successful', secret: users[0].secret });\r\n    } else {\r\n        res.status(401).json({ success: false, message: 'Invalid credentials' });\r\n    }\r\n});\r\n\r\napp.post('/level3/login', async (req, res) => {\r\n    const users = await UserModel.find(req.body);\r\n    if (users.length > 0) {\r\n        res.json({ success: true, message: 'Login successful', secret: users[0].secret });\r\n    } else {\r\n        res.status(401).json({ success: false, message: 'Invalid credentials' });\r\n    }\r\n});\r\n\r\napp.post('/level4/login', async (req, res) => {\r\n    const { username, password } = req.body;\r\n    try {\r\n        const result = await cassandraClient.execute(\r\n            `SELECT * FROM users WHERE username='${username}' AND password='${password}' ALLOW FILTERING`\r\n        );\r\n        if (result.rows.length > 0) {\r\n            res.json({ success: true, message: 'Login successful', secret: result.rows[0].secret });\r\n        } else {\r\n            res.status(401).json({ success: false, message: 'Invalid credentials' });\r\n        }\r\n    } catch (err) {\r\n        res.status(500).json({ message: err.message });\r\n    }\r\n});"
        }
    ]
}